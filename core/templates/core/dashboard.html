{% extends "core/base.html" %}

{% block page_header %}
  <h1 class="mb-2">Dashboard</h1>
  <p class="text-muted">Resumen global de inversión, operaciones y resultados.</p>
{% endblock %}

{% block content %}
  <div class="card shadow-sm border-0 dashboard-wrap">
    <div class="card-body">
      <div class="dashboard-header">
        <div>
          <h2 class="dashboard-title">Resumen ejecutivo</h2>
          <p class="dashboard-subtitle">KPIs actualizados de inversión y rendimiento.</p>
        </div>
        <div class="dashboard-meta">
          <span class="badge text-bg-light">Actualizado</span>
        </div>
      </div>

      {% if pending_solicitudes_count %}
      <div class="alert alert-warning d-flex align-items-center justify-content-between mt-3 mb-0" role="alert">
        <div>
          <strong>{{ pending_solicitudes_count }}</strong> solicitudes de inversión pendientes de revisión.
        </div>
        <a class="btn btn-sm btn-outline-dark" href="{% url 'core:inversores_list' %}">Revisar</a>
      </div>
      {% endif %}

      <div class="dashboard-kpis">
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-people"></i></div>
          <div>
            <span>Inversores activos</span>
            <strong>{{ dashboard_stats.inversores_activos }}</strong>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-person-check"></i></div>
          <div>
            <span>Con cuota pagada</span>
            <strong>{{ dashboard_stats.inversores_cuota }}</strong>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-cash-coin"></i></div>
          <div>
            <span>Capital en vigor</span>
            <strong>{{ dashboard_stats_fmt.capital_en_vigor }}</strong>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-piggy-bank"></i></div>
          <div>
            <span>Capital acumulado</span>
            <strong>{{ dashboard_stats_fmt.capital_acumulado }}</strong>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-layers"></i></div>
          <div>
            <span>Operaciones</span>
            <strong>{{ dashboard_stats.operaciones }}</strong>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon"><i class="bi bi-award"></i></div>
          <div>
            <span>Beneficio Inversure</span>
            <strong>{{ dashboard_stats_fmt.beneficio_inversure }}</strong>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <div class="border rounded-3 p-3 h-100 dashboard-block">
            <div class="block-header">
              <h6 class="text-uppercase text-muted mb-0">Operaciones cerradas</h6>
              <span class="chip chip--success">Histórico</span>
            </div>
            <div class="metric-line">
              <span>Beneficio bruto (total)</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_bruto }}</strong>
            </div>
            <div class="metric-line">
              <span>Beneficio neto (total)</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_neto }}</strong>
            </div>
            <div class="metric-line">
              <span>Beneficio bruto medio</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_bruto_medio }}</strong>
            </div>
            <div class="metric-line">
              <span>Beneficio neto medio</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_neto_medio }}</strong>
            </div>
            <div class="metric-line">
              <span>% bruto total</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_roi_bruto_total }}</strong>
            </div>
            <div class="metric-line">
              <span>% neto total</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_roi_neto_total }}</strong>
            </div>
            <div class="metric-line">
              <span>% bruto medio</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_roi_bruto_medio }}</strong>
            </div>
            <div class="metric-line">
              <span>% neto medio</span>
              <strong>{{ dashboard_stats_fmt.beneficio_cerrado_roi_neto_medio }}</strong>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="border rounded-3 p-3 h-100 dashboard-block">
            <div class="block-header">
              <h6 class="text-uppercase text-muted mb-0">Operaciones abiertas</h6>
              <span class="chip chip--info">En curso</span>
            </div>
            <div class="metric-line">
              <span>Beneficio estimado bruto</span>
              <strong>{{ dashboard_stats_fmt.beneficio_abierto_bruto }}</strong>
            </div>
            <div class="metric-line">
              <span>Beneficio estimado neto</span>
              <strong>{{ dashboard_stats_fmt.beneficio_abierto_neto }}</strong>
            </div>
            <div class="open-chart-wrap"
                 data-bruto="{{ dashboard_stats.beneficio_abierto_bruto|floatformat:2 }}"
                 data-neto="{{ dashboard_stats.beneficio_abierto_neto|floatformat:2 }}"
                 data-center-label="Beneficio medio"
                 data-center-value="{{ dashboard_stats_fmt.beneficio_cerrado_neto_medio }}">
              <canvas id="openBenefitsChart" width="320" height="180"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="dashboard-chart mt-3">
        <div class="chart-legend">
          <span class="legend-item"><span class="legend-dot legend-captacion"></span>Captación</span>
          <span class="legend-item"><span class="legend-dot legend-comprado"></span>Comprado</span>
          <span class="legend-item"><span class="legend-dot legend-comercializacion"></span>Comercialización</span>
          <span class="legend-item"><span class="legend-dot legend-reservado"></span>Reservado</span>
          <span class="legend-item"><span class="legend-dot legend-vendido"></span>Vendido</span>
          <span class="legend-item"><span class="legend-dot legend-cerrado"></span>Cerrado</span>
          <span class="legend-item"><span class="legend-dot legend-descartado"></span>Descartado</span>
        </div>
        {% for item in beneficios_chart %}
          <div class="chart-row">
            <span class="chart-label">
              {{ item.nombre }}
              {% if item.estado_label %}
                <span class="chart-state">· {{ item.estado_label }}</span>
              {% endif %}
            </span>
            <div class="chart-bar">
              <span style="width: {{ item.pct|floatformat:0 }}%; background-color: {{ item.color }};"></span>
            </div>
            <span class="chart-value">{{ item.valor_fmt }}</span>
            <span class="chart-pct">{{ item.pct_fmt }}</span>
          </div>
        {% empty %}
          <div class="text-muted">Sin datos de beneficios todavía.</div>
        {% endfor %}
      </div>

      <div class="dashboard-chart mt-4">
        <div class="block-header mb-3">
          <h6 class="text-uppercase text-muted mb-0">Desviación beneficio (real vs estimado)</h6>
          <span class="chip chip--info">Comparativa</span>
        </div>
        <div class="deviation-chart-wrap">
          <canvas id="benefitDeviationChart" height="140"></canvas>
        </div>
        <div class="row g-2 mt-3" id="benefitDeviationList"></div>
        {{ beneficio_deviation_chart|json_script:"beneficioDeviationData" }}
      </div>

      <div class="dashboard-alerts mt-4">
        <div class="alerts-header">
          <div>
            <h6 class="text-uppercase text-muted mb-0">Alertas operativas</h6>
            <p class="text-muted mb-0">Tareas pendientes del checklist operativo.</p>
          </div>
          <div class="alerts-badges">
            <span class="chip chip--info">Pendientes {{ checklist_alerts.pendientes }}</span>
            <span class="chip chip--warn">Vencidas {{ checklist_alerts.vencidas }}</span>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#alertsCollapse"
                    aria-expanded="false"
                    aria-controls="alertsCollapse">
              Ver detalle
            </button>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'core:checklist_pendientes' %}">Ver todas</a>
          </div>
        </div>

        <div class="collapse mt-3" id="alertsCollapse">
          <div class="alerts-list">
            {% for it in checklist_alerts.items %}
              <div class="alert-item {% if it.overdue %}alert-overdue{% endif %}">
                <div>
                  <div class="alert-title">{{ it.titulo }}</div>
                  <div class="alert-meta">
                    <span>{{ it.proyecto }}</span>
                    <span>· {{ it.fase }}</span>
                    {% if it.responsable %}<span>· {{ it.responsable }}</span>{% endif %}
                  </div>
                </div>
                <div class="alert-date">
                  {% if it.fecha_objetivo %}
                    {{ it.fecha_objetivo|date:"d/m/Y" }}
                    {% if it.overdue %}
                      <span class="alert-delay">+{{ it.dias_retraso }}d</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Sin fecha</span>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="text-muted">Sin tareas pendientes.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    (function () {
      const wrap = document.querySelector(".open-chart-wrap");
      const canvas = document.getElementById("openBenefitsChart");
      if (!wrap || !canvas || !window.Chart) {
        return;
      }
      const bruto = parseFloat(wrap.dataset.bruto || "0") || 0;
      const neto = parseFloat(wrap.dataset.neto || "0") || 0;
      const centerLabel = wrap.dataset.centerLabel || "";
      const centerValue = wrap.dataset.centerValue || "";
      const rootStyle = getComputedStyle(document.documentElement);
      const brandGold = rootStyle.getPropertyValue("--inversure-gold").trim() || "#d7b04c";
      const brandBlue = rootStyle.getPropertyValue("--inversure-blue").trim() || "#122135";
      const ctx = canvas.getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Beneficio bruto", "Beneficio neto"],
          datasets: [{
            data: [bruto, neto],
            backgroundColor: [brandBlue, brandGold],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "62%",
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                boxWidth: 10,
                color: "#64748b",
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.parsed || 0;
                  const formatted = new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    minimumFractionDigits: 2
                  }).format(val);
                  return `${ctx.label}: ${formatted}`;
                }
              }
            }
          }
        },
        plugins: [{
          id: "centerText",
          beforeDraw(chart) {
            if (!centerValue) {
              return;
            }
            const { ctx } = chart;
            const { left, right, top, bottom } = chart.chartArea;
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            ctx.save();
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#64748b";
            ctx.font = "11px Inter, sans-serif";
            if (centerLabel) {
              ctx.fillText(centerLabel, centerX, centerY - 8);
            }
            ctx.fillStyle = "#0f172a";
            ctx.font = "600 14px Inter, sans-serif";
            ctx.fillText(centerValue, centerX, centerY + 10);
            ctx.restore();
          }
        }]
      });

    })();

    (function () {
      const raw = document.getElementById("beneficioDeviationData");
      const canvas = document.getElementById("benefitDeviationChart");
      if (!raw || !canvas || !window.Chart) {
        return;
      }
      let data = [];
      try {
        data = JSON.parse(raw.textContent || "[]");
      } catch (err) {
        data = [];
      }
      if (!Array.isArray(data) || !data.length) {
        return;
      }
      const labels = data.map((row) => row.nombre);
      const estimado = data.map((row) => row.estimado || 0);
      const real = data.map((row) => row.real || 0);
      const rootStyle = getComputedStyle(document.documentElement);
      const brandGold = rootStyle.getPropertyValue("--inversure-gold").trim() || "#d7b04c";
      const brandBlue = rootStyle.getPropertyValue("--inversure-blue").trim() || "#122135";
      const ctx = canvas.getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Estimado base",
              data: estimado,
              backgroundColor: brandGold,
              borderRadius: 8,
              maxBarThickness: 24
            },
            {
              label: "Real",
              data: real,
              backgroundColor: brandBlue,
              borderRadius: 8,
              maxBarThickness: 24
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { boxWidth: 10, color: "#64748b", font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const value = ctx.parsed.y || 0;
                  return `${ctx.dataset.label}: ${value.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#64748b", font: { size: 11 } },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: "#94a3b8",
                callback: (value) => `${value.toLocaleString("es-ES")} €`
              },
              grid: { color: "rgba(148,163,184,0.15)" }
            }
          }
        }
      });

      const list = document.getElementById("benefitDeviationList");
      if (!list) {
        return;
      }
      list.innerHTML = "";
      data.forEach((row) => {
        const estimadoValue = Number(row.estimado || 0);
        const realValue = Number(row.real || 0);
        const diff = realValue - estimadoValue;
        const pct = estimadoValue ? (diff / estimadoValue) * 100 : null;
        const diffLabel = `${diff >= 0 ? "+" : ""}${diff.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
        const pctLabel = pct === null ? "—" : `${pct >= 0 ? "+" : ""}${pct.toFixed(1).replace(".", ",")} %`;
        const badgeClass = diff > 0 ? "text-bg-success" : diff < 0 ? "text-bg-danger" : "text-bg-secondary";

        const col = document.createElement("div");
        col.className = "col-12 col-md-6";
        col.innerHTML = `
          <div class="border rounded-3 p-2 d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">${row.nombre || "Proyecto"}</div>
              <div class="text-muted small">Δ ${diffLabel} · ${pctLabel}</div>
            </div>
            <span class="badge ${badgeClass}">Desviación</span>
          </div>
        `;
        list.appendChild(col);
      });
    })();
  </script>
{% endblock %}
