{% extends "core/base.html" %}
{% load humanize formatting %}
{% block content %}

<style>
  :root{
    --ink:#0b1626;
    --sky:#0f2a44;
    --mist:#f3f6fb;
    --accent:#d4a34f;
    --green:#16a34a;
    --warn:#f59e0b;
  }
  .portal-wrap {
    background: radial-gradient(1200px 400px at 10% -10%, #1b3a5a 0%, #0f1d2e 40%, #0b1626 100%);
    color:#fff;
    border-radius:18px;
    padding:24px;
  }
  .portal-title {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    font-size: 28px;
    letter-spacing: .5px;
  }
  .portal-card {
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:14px;
    padding:16px;
    box-shadow: 0 12px 30px rgba(15,23,42,.08);
  }
  .portal-card--highlight {
    border: 1px solid rgba(212,163,79,.35);
    box-shadow: 0 12px 30px rgba(212,163,79,.15);
  }
  .portal-kpi {
    font-size: 20px;
    font-weight: 800;
    color: var(--ink);
    line-height: 1.15;
    white-space: nowrap;
  }
  .portal-label { color:#64748b; font-size:12px; }
  .badge-soft { background:#f8fafc; border:1px solid #e2e8f0; color:#475569; }
  .btn-portal { background:#122135; color:#fff; }
  .btn-portal:hover { background:#0f1d2e; color:#fff; }
  .list-clean { list-style:none; padding:0; margin:0; }
  .list-clean li { padding:8px 0; border-bottom:1px dashed #e2e8f0; }
  .list-clean li:last-child { border-bottom:none; }
  .tag {
    font-size: 11px;
    padding: 2px 10px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1;
  }
  .tag.ok { background:rgba(22,163,74,.15); color:#166534; }
  .tag.warn { background:rgba(245,158,11,.18); color:#92400e; }
  .tag.mute { background:#f1f5f9; color:#475569; }
  .chart-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 12px 30px rgba(15,23,42,.08);
  }
  .bar-chart {
    display: grid;
    gap: 10px;
  }
  .bar-row {
    display: grid;
    grid-template-columns: 140px 1fr 90px;
    align-items: center;
    gap: 10px;
  }
  .bar-label {
    font-size: 12px;
    color: #475569;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .portal-beneficios-table th {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #122135;
    vertical-align: bottom;
    white-space: normal;
    line-height: 1.2;
  }
  .portal-beneficios-table {
    table-layout: fixed;
    width: 100%;
  }
  .portal-beneficios-table th,
  .portal-beneficios-table td {
    vertical-align: middle;
  }
  .portal-beneficios-table .col-proyecto { width: 15%; }
  .portal-beneficios-table .col-pct { width: 8%; }
  .portal-beneficios-table .col-money { width: 11%; }
  .portal-beneficios-table .col-action { width: 11%; }
  .portal-beneficios-table .col-money,
  .portal-beneficios-table td.col-money {
    white-space: nowrap;
  }
  .portal-beneficios-table td.text-end,
  .portal-beneficios-table th.text-end {
    font-variant-numeric: tabular-nums;
  }
  .portal-beneficios-table input.form-control {
    min-width: 120px;
  }
  .portal-beneficios-table .input-group-text {
    background: #f1f5f9;
    color: #475569;
    border-color: #e2e8f0;
    font-weight: 600;
  }
  .bar-track {
    height: 10px;
    background: #e2e8f0;
    border-radius: 999px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #16a34a, #22c55e);
    border-radius: 999px;
  }
  .bar-value {
    font-size: 12px;
    text-align: right;
    color: #0b1523;
  }
  .donut {
    width: 170px;
    height: 170px;
    border-radius: 50%;
    background: conic-gradient(#0f1d2e 0 0, #e2e8f0 0 100%);
    display: grid;
    place-items: center;
    margin: 0 auto;
  }
  .donut-inner {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 12px;
    color: #475569;
  }
  .donut-inner strong {
    display: block;
    font-size: 18px;
    color: #0b1523;
  }
  .donut-label {
    display: block;
    font-size: 12px;
    color: #64748b;
  }
</style>

  <div class="container mt-4 mb-5">
  <div class="portal-wrap mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="portal-title">Portal del inversor</div>
        <div class="small text-light">{{ perfil.cliente.nombre }} · {{ perfil.cliente.email|default:"" }}</div>
      </div>
      <span class="badge badge-soft">Acceso privado</span>
    </div>
  </div>

{{ beneficio_chart|json_script:"beneficioChartData" }}

  <div class="row g-3">
    <div class="col-md-3">
      <div class="portal-card">
        <div class="portal-label">Total invertido (confirmado)</div>
        <div class="portal-kpi">{{ total_invertido|es_number }} €</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="portal-card">
        <div class="portal-label">Proyectos activos</div>
        <div class="portal-kpi">{{ participaciones|length }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="portal-card">
        <div class="portal-label">Solicitudes pendientes</div>
        <div class="portal-kpi">{{ solicitudes_pendientes|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="portal-card">
        <div class="portal-label">Beneficio total estimado</div>
        <div class="portal-kpi">{{ total_beneficio|es_number }} €</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-7">
      <div class="portal-card">
        <h5 class="mb-3">Mis participaciones</h5>
        {% if participaciones %}
          <ul class="list-clean">
            {% for p in participaciones %}
              <li>
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ p.proyecto.nombre }}</strong>
                    <div class="small text-muted">
                      Aportación: {{ p.importe_invertido|es_number }} €
                      · Participación: {{ p.porcentaje_participacion|default:0|es_number }} %
                    </div>
                  </div>
                  {% if p.estado == "confirmada" %}
                    <span class="tag ok">Confirmada</span>
                  {% elif p.estado == "cancelada" %}
                    <span class="tag mute">Cancelada</span>
                  {% else %}
                    <span class="tag warn">Pendiente</span>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No hay participaciones todavía.</div>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-5">
      <div class="portal-card portal-card--highlight">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Comunicaciones</h5>
          <span class="tag ok">Actualizaciones</span>
        </div>
        {% if comunicaciones %}
          <ul class="list-clean">
            {% for c in comunicaciones %}
              <li>
                <strong>{{ c.titulo }}</strong>
                <div class="small text-muted">{{ c.mensaje|truncatechars:140 }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Sin comunicaciones nuevas.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="portal-card mt-3">
    <h5 class="mb-3">Beneficio por operación</h5>
    {% if beneficios_por_proyecto %}
      <div class="table-responsive">
        <table class="table table-sm align-middle portal-beneficios-table">
          <thead>
            <tr>
              <th class="col-proyecto">Proyecto</th>
              <th class="text-end col-pct">% participación</th>
              <th class="text-end col-money">Beneficio bruto</th>
              <th class="text-end col-money">Comisión Inversure</th>
              <th class="text-end col-money">Beneficio neto total proyecto</th>
              <th class="text-end col-money">Mi beneficio</th>
              <th class="text-end col-money">Retención 19%</th>
              <th class="text-end col-money">Neto a cobrar</th>
              <th class="col-action"></th>
            </tr>
          </thead>
          <tbody>
            {% for b in beneficios_por_proyecto %}
              <tr>
                <td class="col-proyecto">{{ b.proyecto.nombre }}</td>
                <td class="text-end col-pct">{{ b.participacion_pct|es_number }} %</td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="beneficio_bruto" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.beneficio_bruto|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.beneficio_bruto|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="comision_eur" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.comision_eur|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.comision_eur|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="beneficio_neto_total" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.beneficio_neto_total|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.beneficio_neto_total|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="beneficio_inversor" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.beneficio_inversor|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.beneficio_inversor|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="retencion" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.retencion|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.retencion|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-money">
                  {% if internal_view %}
                    <div class="input-group input-group-sm flex-nowrap">
                      <input type="text" name="neto_cobrar" form="beneficio-form-{{ b.participacion_id }}" class="form-control text-end" value="{{ b.neto_cobrar|es_number }}">
                      <span class="input-group-text">€</span>
                    </div>
                  {% else %}
                    {{ b.neto_cobrar|es_number }} €
                  {% endif %}
                </td>
                <td class="text-end col-action">
                  {% if internal_view %}
                    <form id="beneficio-form-{{ b.participacion_id }}" method="post" action="{% url 'core:inversor_beneficio_update' perfil.token b.participacion_id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-secondary">Guardar</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No hay beneficios disponibles todavía.</div>
    {% endif %}
  </div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dataEl = document.getElementById("beneficioChartData");
    const chartEl = document.getElementById("beneficioChart");
    if (!dataEl || !chartEl) return;
    let data = [];
    try {
      data = JSON.parse(dataEl.textContent || "[]");
    } catch (e) {
      data = [];
    }
    if (!Array.isArray(data) || !data.length) {
      chartEl.innerHTML = "<div class='text-muted small'>Sin datos de beneficios.</div>";
      return;
    }
    const maxVal = Math.max(...data.map(d => Number(d.beneficio) || 0), 1);
    chartEl.innerHTML = data.map(d => {
      const date = d.fecha ? new Date(d.fecha).toLocaleDateString("es-ES") : "";
      const label = d.label || "Proyecto";
      const val = Number(d.beneficio) || 0;
      const inv = Number(d.inversion) || 0;
      const pctInv = inv > 0 ? (val / inv) * 100 : (Number(d.pct) || 0);
      const pct = Math.min(100, Math.max(0, (val / maxVal) * 100));
      return `
        <div class="bar-row">
          <div class="bar-label">${label}<br><span class="text-muted">${date}</span></div>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%;"></div></div>
          <div class="bar-value">
            ${new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(val)}
            <br><span class="text-muted">${pctInv.toFixed(2)}%</span>
          </div>
        </div>
      `;
    }).join("");

    const donut = document.getElementById("beneficioDonut");
    if (donut) {
      const total = Number(donut.getAttribute("data-total") || 0);
      const ret = Number(donut.getAttribute("data-retencion") || 0);
      const neto = Math.max(total - ret, 0);
      const pct = total > 0 ? Math.min(100, Math.max(0, (neto / total) * 100)) : 0;
      donut.style.background = `conic-gradient(#16a34a 0 ${pct}%, #e2e8f0 ${pct}% 100%)`;
    }
  });
</script>

  <div class="row g-3 mt-3">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5 class="mb-3">Beneficio por operación y tiempo</h5>
        <div id="beneficioChart" class="bar-chart"></div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card text-center">
        <h5 class="mb-3">Beneficio acumulado</h5>
        <div class="donut" id="beneficioDonut" data-total="{{ total_beneficio }}" data-retencion="{{ total_retencion }}">
          <div class="donut-inner">
            <strong>{{ total_beneficio|es_number }} €</strong>
            <span class="donut-label">Neto acumulado</span>
          </div>
        </div>
        <div class="mt-3 small text-muted">
          Retención total: {{ total_retencion|es_number }} € · Neto a cobrar: {{ total_neto_cobrar|es_number }} €
        </div>
      </div>
    </div>
  </div>

  <div class="portal-card mt-3">
    <h5 class="mb-3">Documentación personal</h5>
    {% if documentos_personales %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Título</th>
              <th>Categoría</th>
              <th>Fecha</th>
              <th class="text-end">Archivo</th>
            </tr>
          </thead>
          <tbody>
            {% for d in documentos_personales %}
              <tr>
                <td>{{ d.titulo }}</td>
                <td>{{ d.get_categoria_display }}</td>
                <td>{{ d.creado|date:"d/m/Y" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ d.signed_url|default:d.archivo.url }}" target="_blank" rel="noopener">Descargar</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No hay documentación personal todavía.</div>
    {% endif %}
  </div>

  {% if internal_view %}
  <div class="portal-card mt-3" id="com_preview_card">
    <h5 class="mb-3">Comunicaciones (vista previa)</h5>
    {% if proyectos_participados %}
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Proyecto</label>
          <select class="form-select" id="inv_com_proyecto">
            {% for p in proyectos_participados %}
              <option value="{{ p.id }}">{{ p.nombre|default:"Proyecto" }} · ID {{ p.id }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Plantilla</label>
          <select class="form-select" id="inv_com_template">
            <option value="">— Manual —</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-nowrap" id="inv_com_generate_btn">Generar</button>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-portal btn-sm w-100 text-nowrap" id="inv_com_preview_btn">Vista previa PDF</button>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <label class="form-label">Título</label>
          <input type="text" class="form-control" id="inv_com_titulo" placeholder="Actualización de proyecto">
        </div>
        <div class="col-md-8">
          <label class="form-label">Mensaje</label>
          <textarea class="form-control" id="inv_com_mensaje" rows="2" placeholder="Resumen breve para inversores"></textarea>
          <div class="form-text" id="inv_com_destinatarios">Vista previa individual para este inversor.</div>
        </div>
      </div>
      <div class="mt-3" id="inv_com_anexos">
        <div class="fw-semibold mb-2">Anexos PDF (documentacion inmueble)</div>
        <div class="text-muted">No hay documentos disponibles para anexar.</div>
      </div>
    {% else %}
      <div class="text-muted">Este inversor aún no tiene proyectos confirmados.</div>
    {% endif %}
  </div>

  <div class="portal-card mt-3">
    <h5 class="mb-3">Ajuste de aportación inicial</h5>
    <form method="post" action="{% url 'core:inversor_portal_config' perfil.id %}">
      {% csrf_token %}
      <input type="hidden" name="aportacion_submit" value="1">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Aportación inicial</label>
          <input type="text" name="aportacion_inicial_override" class="form-control" value="{{ aportacion_inicial_override|default:aportacion_inicial|es_number }}">
          <div class="form-text">Deja en blanco para usar la primera aportación confirmada.</div>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-portal btn-sm">Guardar</button>
        </div>
      </div>
    </form>
  </div>

  <div class="portal-card mt-3">
    <h5 class="mb-3">Visibilidad del portal</h5>
    <form method="post" action="{% url 'core:inversor_portal_config' perfil.id %}">
      {% csrf_token %}
      <input type="hidden" name="visibilidad_submit" value="1">
      <div class="row g-2">
        {% for p in proyectos_candidatos %}
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="proyectos_visibles" value="{{ p.id }}"
                     id="proyecto_visible_{{ p.id }}" {% if p.id in proyectos_visibles %}checked{% endif %}>
              <label class="form-check-label" for="proyecto_visible_{{ p.id }}">
                {{ p.nombre }} · {{ p.estado|capfirst }}
              </label>
            </div>
          </div>
        {% empty %}
          <div class="text-muted">No hay proyectos disponibles para mostrar.</div>
        {% endfor %}
      </div>
      <button type="submit" class="btn btn-portal btn-sm mt-3">Guardar visibilidad</button>
    </form>
  </div>
  {% endif %}

  <div class="portal-card mt-3">
    <h5 class="mb-3">Proyectos disponibles</h5>
    {% if proyectos_abiertos %}
      <div class="row g-3">
        {% for p in proyectos_abiertos %}
        <div class="col-md-6">
          <div class="border rounded p-3 h-100">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ p.nombre }}</strong>
                <div class="small text-muted">Estado: {{ p.estado|default:"activo" }}</div>
                {% if p.capital_objetivo and p.capital_objetivo > 0 %}
                  <div class="small text-muted">
                    Captado: {{ p.capital_captado|es_number }} € /
                    {{ p.capital_objetivo|es_number }} €
                  </div>
                  <div class="small text-muted">
                    Falta: {{ p.falta_pct|es_number }} % · {{ p.falta_eur|es_number }} €
                  </div>
                {% endif %}
              </div>
            </div>
            <form method="post" action="{% url 'core:inversor_solicitar' perfil.token p.id %}" class="mt-2">
              {% csrf_token %}
              <div class="row g-2">
                <div class="col-6">
                  <input type="number" step="0.01" name="importe" class="form-control form-control-sm" placeholder="Importe €" required>
                </div>
                <div class="col-6">
                  {% if p.puede_solicitar %}
                    <button type="submit" class="btn btn-portal btn-sm w-100">Solicitar</button>
                  {% else %}
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" disabled>Completo</button>
                  {% endif %}
                </div>
                <div class="col-12">
                  <input type="text" name="comentario" class="form-control form-control-sm" placeholder="Comentario (opcional)">
                </div>
              </div>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">No hay proyectos abiertos para inversión.</div>
    {% endif %}
  </div>
</div>

{% if internal_view %}
<script>
  (function () {
    const proyectoEl = document.getElementById("inv_com_proyecto");
    const templateEl = document.getElementById("inv_com_template");
    const btnGenerate = document.getElementById("inv_com_generate_btn");
    const btnPreview = document.getElementById("inv_com_preview_btn");
    const elTitulo = document.getElementById("inv_com_titulo");
    const elMensaje = document.getElementById("inv_com_mensaje");
    const anexosWrap = document.getElementById("inv_com_anexos");
    if (!proyectoEl || !btnPreview) return;

    const baseUrl = "{% url 'core:proyecto_comunicaciones' 0 %}";
    const previewUrl = "{% url 'core:inversor_comunicacion_preview' perfil.id %}";

    function getCsrfToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : "";
    }

    function getProjectUrl() {
      return baseUrl.replace("/0/", "/" + proyectoEl.value + "/");
    }

    async function loadTemplatesDocs() {
      try {
        const resp = await fetch(getProjectUrl(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await resp.json();
        if (!data || !data.ok) return;
        if (templateEl && Array.isArray(data.templates)) {
          const current = templateEl.value;
          const options = [
            `<option value="">— Manual —</option>`,
            ...data.templates.map(t => `<option value="${t.key}">${t.label}</option>`)
          ];
          templateEl.innerHTML = options.join("");
          if (current) templateEl.value = current;
        }
        if (anexosWrap) {
          const docs = Array.isArray(data.documentos) ? data.documentos : [];
          if (!docs.length) {
            anexosWrap.innerHTML = `
              <div class="fw-semibold mb-2">Anexos PDF (documentacion inmueble)</div>
              <div class="text-muted">No hay documentos disponibles para anexar.</div>
            `;
          } else {
            anexosWrap.innerHTML = `
              <div class="fw-semibold mb-2">Anexos PDF (documentacion inmueble)</div>
              <div class="d-flex flex-wrap gap-3">
                ${docs.map(doc => `
                  <label class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="checkbox" name="inv_com_doc" value="${doc.id}">
                    <span class="form-check-label">${doc.titulo || "Documento"}</span>
                  </label>
                `).join("")}
              </div>
            `;
          }
        }
      } catch (e) {}
    }

    if (btnGenerate) {
      btnGenerate.addEventListener("click", async () => {
        const templateKey = (templateEl && templateEl.value || "").trim();
        if (!templateKey) {
          alert("Selecciona una plantilla para generar el borrador.");
          return;
        }
        const resp = await fetch(previewUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(getCsrfToken() ? { "X-CSRFToken": getCsrfToken() } : {}),
          },
          body: JSON.stringify({
            proyecto_id: proyectoEl.value,
            template_key: templateKey,
            preview_only: true,
          }),
        });
        if (!resp.ok) {
          alert("No se pudo generar la comunicación.");
          return;
        }
        const data = await resp.json();
        if (elTitulo) elTitulo.value = data.titulo || "";
        if (elMensaje) elMensaje.value = data.mensaje || "";
      });
    }

    btnPreview.addEventListener("click", async () => {
      const templateKey = (templateEl && templateEl.value || "").trim();
      const titulo = (elTitulo && elTitulo.value || "").trim();
      const mensaje = (elMensaje && elMensaje.value || "").trim();
      const docIds = Array.from(document.querySelectorAll("input[name='inv_com_doc']:checked"))
        .map(el => el.value)
        .filter(Boolean);

      if (!templateKey && (!titulo || !mensaje)) {
        alert("Título y mensaje son obligatorios.");
        return;
      }
      const payload = { proyecto_id: proyectoEl.value };
      if (templateKey) {
        payload.template_key = templateKey;
      } else {
        payload.titulo = titulo;
        payload.mensaje = mensaje;
      }
      if (docIds.length) payload.doc_ids = docIds;

      const resp = await fetch(previewUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(getCsrfToken() ? { "X-CSRFToken": getCsrfToken() } : {}),
        },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        let err = "No se pudo generar la vista previa.";
        try {
          const data = await resp.json();
          if (data && data.error) err = data.error;
        } catch (e) {}
        alert(err);
        return;
      }
      const contentType = resp.headers.get("Content-Type") || "";
      if (!contentType.includes("application/pdf")) {
        alert("No se pudo generar el PDF.");
        return;
      }
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener");
    });

    proyectoEl.addEventListener("change", loadTemplatesDocs);
    loadTemplatesDocs();
  })();
</script>
{% endif %}

{% endblock %}
