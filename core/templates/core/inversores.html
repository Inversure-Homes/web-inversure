{% extends "core/base.html" %}
{% load humanize formatting %}
{% block content %}
<style>
  :root {
    --ink:#0b1523;
    --slate:#475569;
    --steel:#1f2a3a;
    --gold:#d4a34f;
    --paper:#f7f9fc;
    --line:#e2e8f0;
  }
  .inv-hero {
    background: linear-gradient(120deg, #0f1d2e 0%, #12263f 60%, #0b1523 100%);
    color: #fff;
    border-radius: 18px;
    padding: 22px 24px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
  }
  .inv-hero h1 {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    font-size: 28px;
    margin: 0;
    letter-spacing: .4px;
  }
  .inv-hero .muted {
    color: rgba(255,255,255,.72);
  }
  .inv-kpi {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 10px 26px rgba(15,23,42,.08);
  }
  .inv-kpi .label { color: var(--slate); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
  .inv-kpi .value { color: var(--ink); font-size: 20px; font-weight: 800; }
  .inv-card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 12px 30px rgba(15,23,42,.08);
    height: 100%;
  }
  .inv-card h3 {
    font-size: 18px;
    margin: 0;
    color: var(--ink);
  }
  .inv-tag {
    font-size: 11px;
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 2px 8px;
    color: var(--slate);
  }
  .inv-meta { color: var(--slate); font-size: 13px; }
  .inv-stats {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 10px;
  }
  .inv-stat {
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 10px 12px;
  }
  .inv-stat .label { font-size: 11px; color: var(--slate); }
  .inv-stat .value { font-size: 16px; font-weight: 700; color: var(--ink); }
  .inv-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .inv-list li {
    padding: 6px 0;
    border-bottom: 1px dashed var(--line);
    font-size: 13px;
  }
  .inv-list li:last-child { border-bottom: none; }
  .btn-portal {
    background: var(--steel);
    color: #fff;
  }
  .btn-portal:hover {
    background: #0f1d2e;
    color: #fff;
  }
  @media (max-width: 991px) {
    .inv-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 575px) {
    .inv-stats { grid-template-columns: 1fr; }
  }
</style>

<div class="container mt-4 mb-5">
  <div class="inv-hero mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h1>Inversores</h1>
        <div class="muted small">Resumen operativo de clientes inversores y acceso a sus fichas.</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-portal btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modalBuscarInversor">Añadir inversor</button>
        <span class="inv-tag">Portal privado</span>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Inversores activos</div>
        <div class="value">{{ total_inversores|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Capital invertido</div>
        <div class="value">{{ total_invertido|es_number }} €</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Participaciones</div>
        <div class="value">{{ total_participaciones|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Solicitudes pendientes</div>
        <div class="value">{{ total_pendientes|default:0 }}</div>
      </div>
    </div>
  </div>

  <div class="inv-card mt-4">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Buscar inversor</label>
        <input type="text" name="q" class="form-control" placeholder="Nombre, DNI, email o teléfono" value="{{ q|default:'' }}">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-portal btn-sm w-100">Buscar</button>
      </div>
      <div class="col-md-3 text-md-end">
        <div class="inv-meta mt-2 mt-md-4">
          Mostrando {{ total_inversores_filtrados|default:0 }} de {{ total_inversores|default:0 }}
        </div>
      </div>
    </form>
  </div>

  <div class="inv-card mt-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h3>Comunicaciones a inversores</h3>
        <div class="inv-meta">Listado de últimas comunicaciones enviadas por proyecto.</div>
      </div>
    </div>
    {% if proyectos %}
      <div class="row g-3 align-items-end mt-1">
        <div class="col-md-4">
          <label class="form-label">Proyecto</label>
          <select class="form-select" id="com_proyecto">
            {% for p in proyectos %}
              <option value="{{ p.id }}">{{ p.nombre|default:"Proyecto" }} · ID {{ p.id }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Rango</label>
          <select class="form-select" id="com_rango">
            <option value="7">Últimos 7 días</option>
            <option value="30" selected>Últimos 30 días</option>
            <option value="90">Últimos 90 días</option>
            <option value="all">Todo</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Vista</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="com_toggle_all">Ver todo</button>
          </div>
        </div>
        <div class="col-md-2 text-md-end">
          <div class="inv-meta" id="com_count">—</div>
        </div>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Título</th>
              <th>Mensaje</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="inv_comunicaciones_rows">
            <tr><td colspan="4" class="text-muted">Selecciona un proyecto para ver comunicaciones.</td></tr>
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="inv-meta mt-2">No hay proyectos disponibles para comunicaciones.</div>
    {% endif %}
  </div>

  <div class="row g-4 mt-1">
    {% for inv in inversores %}
    <div class="col-lg-6">
      <div class="inv-card">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <h3>{{ inv.cliente.nombre }}</h3>
            <div class="inv-meta">
              {{ inv.cliente.get_tipo_persona_display }} · {{ inv.cliente.dni_cif }}
            </div>
            <div class="inv-meta">
              {{ inv.cliente.email|default:"Sin email" }} · {{ inv.cliente.telefono|default:"Sin teléfono" }}
            </div>
          </div>
          <span class="inv-tag">Token activo</span>
        </div>

        <div class="inv-stats mt-3">
          <div class="inv-stat">
            <div class="label">Total invertido</div>
            <div class="value">{{ inv.total_invertido|es_number }} €</div>
          </div>
          <div class="inv-stat">
            <div class="label">Aportación inicial</div>
            <div class="value">{{ inv.aportacion_inicial|es_number }} €</div>
          </div>
          <div class="inv-stat">
            <div class="label">Proyectos activos</div>
            <div class="value">{{ inv.proyectos_activos|default:0 }}</div>
          </div>
          <div class="inv-stat">
            <div class="label">Participaciones</div>
            <div class="value">{{ inv.num_participaciones|default:0 }}</div>
          </div>
          <div class="inv-stat">
            <div class="label">Solicitudes pendientes</div>
            <div class="value">{{ inv.solicitudes_pendientes|default:0 }}</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="inv-meta fw-semibold mb-2">Últimas participaciones</div>
          {% if inv.participaciones_preview %}
            <ul class="inv-list">
              {% for p in inv.participaciones_preview %}
                <li>
                  {{ p.proyecto.nombre|default:"Proyecto" }} · {{ p.importe_invertido|es_number }} €
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="inv-meta">Sin participaciones confirmadas.</div>
          {% endif %}
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
          <a href="{% url 'core:inversor_portal' inv.perfil.token %}" class="btn btn-sm btn-portal">Portal inversor</a>
          <a href="{% url 'core:inversor_portal_admin' inv.perfil.id %}" class="btn btn-sm btn-outline-primary">Editar portal</a>
          <a href="{% url 'core:cliente_inversor_link' inv.cliente.id %}" class="btn btn-sm btn-outline-secondary">Acceso inversor</a>
        </div>

        <div class="mt-3">
          <div class="inv-meta fw-semibold mb-2">
            Documentación personal ({{ inv.documentos|length|default:0 }})
          </div>
          {% if inv.documentos %}
            <ul class="inv-list" data-doc-list data-page-size="10">
              {% for d in inv.documentos %}
                <li>
                  {{ d.get_categoria_display }} · {{ d.titulo }}
                  <a class="ms-2" href="{{ d.signed_url|default:d.archivo.url }}" target="_blank" rel="noopener">Descargar</a>
                  <form method="post" action="{% url 'core:inversor_documento_borrar' inv.perfil.id d.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger ms-2">Borrar</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
            <div class="inv-meta d-flex align-items-center gap-2 mt-2" data-doc-controls>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-doc-prev>Anterior</button>
              <span data-doc-page>1</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-doc-next>Siguiente</button>
            </div>
          {% else %}
            <div class="inv-meta">Sin documentos subidos.</div>
          {% endif %}
        </div>

        <div class="mt-3">
          <form method="post" action="{% url 'core:inversor_documento_upload' inv.perfil.id %}" enctype="multipart/form-data" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-md-4">
              <label class="inv-meta fw-semibold">Título</label>
              <input type="text" name="doc_titulo" class="form-control form-control-sm" placeholder="Ej. Contrato" required>
            </div>
            <div class="col-md-3">
              <label class="inv-meta fw-semibold">Categoría</label>
              <select name="doc_categoria" class="form-select form-select-sm">
                <option value="contrato">Contrato</option>
                <option value="retenciones">Certificado retenciones</option>
                <option value="comunicaciones">Comunicaciones</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="inv-meta fw-semibold">Archivo</label>
              <input type="file" name="doc_archivo" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-sm btn-portal w-100">Subir</button>
            </div>
          </form>
        </div>

        <div class="inv-meta mt-3">
          Comunicaciones: {{ inv.total_comunicaciones|default:0 }}
          {% if inv.ultima_comunicacion %}
            · Última: {{ inv.ultima_comunicacion|date:"d/m/Y" }}
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="inv-card text-center">
        <div class="inv-meta">No hay inversores registrados todavía.</div>
        <div class="mt-2">
          <a href="{% url 'core:clientes' %}" class="btn btn-sm btn-outline-primary">Crear cliente inversor</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="d-flex justify-content-center mt-4">
      <nav aria-label="Paginación inversores">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            {% if page_obj.has_previous %}
              <a class="page-link" href="?q={{ q|urlencode }}&page={{ page_obj.previous_page_number }}">Anterior</a>
            {% else %}
              <span class="page-link">Anterior</span>
            {% endif %}
          </li>
          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?q={{ q|urlencode }}&page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            {% if page_obj.has_next %}
              <a class="page-link" href="?q={{ q|urlencode }}&page={{ page_obj.next_page_number }}">Siguiente</a>
            {% else %}
              <span class="page-link">Siguiente</span>
            {% endif %}
          </li>
        </ul>
      </nav>
    </div>
  {% endif %}
</div>

<div class="modal fade" id="modalBuscarInversor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Buscar cliente para inversor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form method="get" action="{% url 'core:inversor_buscar' %}">
        <div class="modal-body">
          <p class="text-muted small mb-3">Busca por DNI/NIE/CIF o email. Si no existe, se abrirá el alta con datos precargados.</p>
          <div class="mb-3">
            <label class="form-label">DNI/NIE/CIF</label>
            <input type="text" name="dni_cif" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-portal">Buscar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function () {
    const proyectoEl = document.getElementById("com_proyecto");
    const rangoEl = document.getElementById("com_rango");
    const toggleAllBtn = document.getElementById("com_toggle_all");
    const countEl = document.getElementById("com_count");
    const tabla = document.getElementById("inv_comunicaciones_rows");
    if (!proyectoEl || !tabla) return;

    const baseUrl = "{% url 'core:proyecto_comunicaciones' 0 %}";
    let showAll = false;

    function getUrl() {
      const id = proyectoEl.value;
      return baseUrl.replace("/0/", "/" + id + "/");
    }

    function filterByRange(rows) {
      const rango = rangoEl ? rangoEl.value : "30";
      if (rango === "all") return rows;
      const dias = parseInt(rango, 10);
      if (!dias) return rows;
      const now = new Date();
      const limit = new Date(now.getTime() - dias * 24 * 60 * 60 * 1000);
      return rows.filter(r => {
        if (!r.fecha) return true;
        const dt = new Date(r.fecha);
        return !isNaN(dt) && dt >= limit;
      });
    }

    async function loadRows() {
      const url = getUrl();
      try {
        const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await resp.json();
        if (!data || !data.ok) return;
        let rows = data.comunicaciones || [];
        if (!rows.length) {
          tabla.innerHTML = "<tr><td colspan=\"4\" class=\"text-muted\">Sin comunicaciones todavía.</td></tr>";
          if (countEl) countEl.textContent = "0";
          return;
        }
        rows = rows.slice().sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""));
        const filtered = filterByRange(rows);
        const visible = showAll ? filtered : filtered.slice(0, 5);
        if (countEl) countEl.textContent = `${visible.length} de ${filtered.length}`;
        if (toggleAllBtn) toggleAllBtn.textContent = showAll ? "Ver menos" : "Ver todo";
        if (!visible.length) {
          tabla.innerHTML = "<tr><td colspan=\"4\" class=\"text-muted\">Sin comunicaciones en este rango.</td></tr>";
          return;
        }
        tabla.innerHTML = visible.map(r => {
          const fecha = r.fecha ? r.fecha.slice(0, 10).split("-").reverse().join("/") : "";
          return `
            <tr>
              <td>${r.cliente_nombre}</td>
              <td>${r.titulo}</td>
              <td>${r.mensaje}</td>
              <td>${fecha}</td>
            </tr>
          `;
        }).join("");
      } catch (e) {}
    }

    proyectoEl.addEventListener("change", () => {
      showAll = false;
      loadRows();
    });
    if (rangoEl) {
      rangoEl.addEventListener("change", () => {
        showAll = false;
        loadRows();
      });
    }
    if (toggleAllBtn) {
      toggleAllBtn.addEventListener("click", () => {
        showAll = !showAll;
        loadRows();
      });
    }
    loadRows();
  })();
</script>

<script>
  (function () {
    const lists = document.querySelectorAll("[data-doc-list]");
    lists.forEach((list) => {
      const items = Array.from(list.querySelectorAll("li"));
      const pageSize = parseInt(list.dataset.pageSize || "10", 10);
      const controls = list.parentElement.querySelector("[data-doc-controls]");
      const btnPrev = controls ? controls.querySelector("[data-doc-prev]") : null;
      const btnNext = controls ? controls.querySelector("[data-doc-next]") : null;
      const pageLabel = controls ? controls.querySelector("[data-doc-page]") : null;
      if (!controls || items.length <= pageSize) {
        if (controls) {
          controls.style.display = "none";
        }
        return;
      }

      let page = 1;
      const totalPages = Math.max(1, Math.ceil(items.length / pageSize));

      const render = () => {
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        items.forEach((item, idx) => {
          item.style.display = idx >= start && idx < end ? "" : "none";
        });
        if (pageLabel) {
          pageLabel.textContent = `${page} / ${totalPages}`;
        }
        if (btnPrev) btnPrev.disabled = page <= 1;
        if (btnNext) btnNext.disabled = page >= totalPages;
      };

      if (btnPrev) {
        btnPrev.addEventListener("click", () => {
          page = Math.max(1, page - 1);
          render();
        });
      }
      if (btnNext) {
        btnNext.addEventListener("click", () => {
          page = Math.min(totalPages, page + 1);
          render();
        });
      }

      render();
    });
  })();
</script>
{% endblock %}
