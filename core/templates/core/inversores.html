{% extends "core/base.html" %}
{% load humanize %}
{% block content %}
<style>
  :root {
    --ink:#0b1523;
    --slate:#475569;
    --steel:#1f2a3a;
    --gold:#d4a34f;
    --paper:#f7f9fc;
    --line:#e2e8f0;
  }
  .inv-hero {
    background: linear-gradient(120deg, #0f1d2e 0%, #12263f 60%, #0b1523 100%);
    color: #fff;
    border-radius: 18px;
    padding: 22px 24px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
  }
  .inv-hero h1 {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    font-size: 28px;
    margin: 0;
    letter-spacing: .4px;
  }
  .inv-hero .muted {
    color: rgba(255,255,255,.72);
  }
  .inv-kpi {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 10px 26px rgba(15,23,42,.08);
  }
  .inv-kpi .label { color: var(--slate); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
  .inv-kpi .value { color: var(--ink); font-size: 20px; font-weight: 800; }
  .inv-card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 12px 30px rgba(15,23,42,.08);
    height: 100%;
  }
  .inv-card h3 {
    font-size: 18px;
    margin: 0;
    color: var(--ink);
  }
  .inv-tag {
    font-size: 11px;
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 2px 8px;
    color: var(--slate);
  }
  .inv-meta { color: var(--slate); font-size: 13px; }
  .inv-stats {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
  }
  .inv-stat {
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 10px 12px;
  }
  .inv-stat .label { font-size: 11px; color: var(--slate); }
  .inv-stat .value { font-size: 16px; font-weight: 700; color: var(--ink); }
  .inv-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .inv-list li {
    padding: 6px 0;
    border-bottom: 1px dashed var(--line);
    font-size: 13px;
  }
  .inv-list li:last-child { border-bottom: none; }
  .btn-portal {
    background: var(--steel);
    color: #fff;
  }
  .btn-portal:hover {
    background: #0f1d2e;
    color: #fff;
  }
  @media (max-width: 991px) {
    .inv-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 575px) {
    .inv-stats { grid-template-columns: 1fr; }
  }
</style>

<div class="container mt-4 mb-5">
  <div class="inv-hero mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h1>Inversores</h1>
        <div class="muted small">Resumen operativo de clientes inversores y acceso a sus fichas.</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'core:clientes_form' %}" class="btn btn-portal btn-sm">Añadir inversor</a>
        <span class="inv-tag">Portal privado</span>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Inversores activos</div>
        <div class="value">{{ total_inversores|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Capital invertido</div>
        <div class="value">{{ total_invertido|floatformat:2|intcomma }} €</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Participaciones</div>
        <div class="value">{{ total_participaciones|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="inv-kpi">
        <div class="label">Solicitudes pendientes</div>
        <div class="value">{{ total_pendientes|default:0 }}</div>
      </div>
    </div>
  </div>

  <div class="inv-card mt-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h3>Comunicaciones a inversores</h3>
        <div class="inv-meta">Envía avisos por proyecto a los inversores confirmados.</div>
      </div>
    </div>
    {% if proyectos %}
      <div class="row g-3 align-items-end mt-1">
        <div class="col-md-3">
          <label class="form-label">Proyecto</label>
          <select class="form-select" id="com_proyecto">
            {% for p in proyectos %}
              <option value="{{ p.id }}">{{ p.nombre|default:"Proyecto" }} · ID {{ p.id }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Título</label>
          <input type="text" class="form-control" id="com_titulo" placeholder="Actualización de proyecto">
        </div>
        <div class="col-md-4">
          <label class="form-label">Mensaje</label>
          <input type="text" class="form-control" id="com_mensaje" placeholder="Resumen breve para inversores">
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-portal btn-sm w-100 text-nowrap" id="com_send_btn">Enviar</button>
        </div>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Título</th>
              <th>Mensaje</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="inv_comunicaciones_rows">
            <tr><td colspan="4" class="text-muted">Selecciona un proyecto para ver comunicaciones.</td></tr>
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="inv-meta mt-2">No hay proyectos disponibles para comunicaciones.</div>
    {% endif %}
  </div>

  <div class="row g-4 mt-1">
    {% for inv in inversores %}
    <div class="col-lg-6">
      <div class="inv-card">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <h3>{{ inv.cliente.nombre }}</h3>
            <div class="inv-meta">
              {{ inv.cliente.get_tipo_persona_display }} · {{ inv.cliente.dni_cif }}
            </div>
            <div class="inv-meta">
              {{ inv.cliente.email|default:"Sin email" }} · {{ inv.cliente.telefono|default:"Sin teléfono" }}
            </div>
          </div>
          <span class="inv-tag">Token activo</span>
        </div>

        <div class="inv-stats mt-3">
          <div class="inv-stat">
            <div class="label">Total invertido</div>
            <div class="value">{{ inv.total_invertido|floatformat:2|intcomma }} €</div>
          </div>
          <div class="inv-stat">
            <div class="label">Proyectos activos</div>
            <div class="value">{{ inv.proyectos_activos|default:0 }}</div>
          </div>
          <div class="inv-stat">
            <div class="label">Participaciones</div>
            <div class="value">{{ inv.num_participaciones|default:0 }}</div>
          </div>
          <div class="inv-stat">
            <div class="label">Solicitudes pendientes</div>
            <div class="value">{{ inv.solicitudes_pendientes|default:0 }}</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="inv-meta fw-semibold mb-2">Últimas participaciones</div>
          {% if inv.participaciones_preview %}
            <ul class="inv-list">
              {% for p in inv.participaciones_preview %}
                <li>
                  {{ p.proyecto.nombre|default:"Proyecto" }} · {{ p.importe_invertido|floatformat:2|intcomma }} €
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="inv-meta">Sin participaciones confirmadas.</div>
          {% endif %}
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
          <a href="{% url 'core:inversor_portal' inv.perfil.token %}" class="btn btn-sm btn-portal">Portal inversor</a>
          <a href="{% url 'core:inversor_portal_admin' inv.perfil.id %}" class="btn btn-sm btn-outline-primary">Editar portal</a>
          <a href="{% url 'core:cliente_inversor_link' inv.cliente.id %}" class="btn btn-sm btn-outline-secondary">Acceso inversor</a>
        </div>

        <div class="mt-3">
          <div class="inv-meta fw-semibold mb-2">
            Documentación personal ({{ inv.documentos|length|default:0 }})
          </div>
          {% if inv.documentos %}
            <ul class="inv-list" data-doc-list data-page-size="10">
              {% for d in inv.documentos %}
                <li>
                  {{ d.get_categoria_display }} · {{ d.titulo }}
                  <a class="ms-2" href="{{ d.signed_url|default:d.archivo.url }}" target="_blank" rel="noopener">Descargar</a>
                  <form method="post" action="{% url 'core:inversor_documento_borrar' inv.perfil.id d.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger ms-2">Borrar</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
            <div class="inv-meta d-flex align-items-center gap-2 mt-2" data-doc-controls>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-doc-prev>Anterior</button>
              <span data-doc-page>1</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-doc-next>Siguiente</button>
            </div>
          {% else %}
            <div class="inv-meta">Sin documentos subidos.</div>
          {% endif %}
        </div>

        <div class="mt-3">
          <form method="post" action="{% url 'core:inversor_documento_upload' inv.perfil.id %}" enctype="multipart/form-data" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-md-4">
              <label class="inv-meta fw-semibold">Título</label>
              <input type="text" name="doc_titulo" class="form-control form-control-sm" placeholder="Ej. Contrato" required>
            </div>
            <div class="col-md-3">
              <label class="inv-meta fw-semibold">Categoría</label>
              <select name="doc_categoria" class="form-select form-select-sm">
                <option value="contrato">Contrato</option>
                <option value="retenciones">Certificado retenciones</option>
                <option value="comunicaciones">Comunicaciones</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="inv-meta fw-semibold">Archivo</label>
              <input type="file" name="doc_archivo" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-sm btn-portal w-100">Subir</button>
            </div>
          </form>
        </div>

        <div class="inv-meta mt-3">
          Comunicaciones: {{ inv.total_comunicaciones|default:0 }}
          {% if inv.ultima_comunicacion %}
            · Última: {{ inv.ultima_comunicacion|date:"d/m/Y" }}
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="inv-card text-center">
        <div class="inv-meta">No hay inversores registrados todavía.</div>
        <div class="mt-2">
          <a href="{% url 'core:clientes' %}" class="btn btn-sm btn-outline-primary">Crear cliente inversor</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  (function () {
    const proyectoEl = document.getElementById("com_proyecto");
    const tabla = document.getElementById("inv_comunicaciones_rows");
    const btnSend = document.getElementById("com_send_btn");
    const elTitulo = document.getElementById("com_titulo");
    const elMensaje = document.getElementById("com_mensaje");
    if (!proyectoEl || !tabla || !btnSend) return;

    const baseUrl = "{% url 'core:proyecto_comunicaciones' 0 %}";

    function getCsrfToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : "";
    }

    function getUrl() {
      const id = proyectoEl.value;
      return baseUrl.replace("/0/", "/" + id + "/");
    }

    async function loadRows() {
      const url = getUrl();
      try {
        const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await resp.json();
        if (!data || !data.ok) return;
        const rows = data.comunicaciones || [];
        if (!rows.length) {
          tabla.innerHTML = "<tr><td colspan=\"4\" class=\"text-muted\">Sin comunicaciones todavía.</td></tr>";
          return;
        }
        tabla.innerHTML = rows.map(r => {
          const fecha = r.fecha ? r.fecha.slice(0, 10).split("-").reverse().join("/") : "";
          return `
            <tr>
              <td>${r.cliente_nombre}</td>
              <td>${r.titulo}</td>
              <td>${r.mensaje}</td>
              <td>${fecha}</td>
            </tr>
          `;
        }).join("");
      } catch (e) {}
    }

    btnSend.addEventListener("click", async () => {
      const titulo = (elTitulo && elTitulo.value || "").trim();
      const mensaje = (elMensaje && elMensaje.value || "").trim();
      if (!titulo || !mensaje) {
        alert("Título y mensaje son obligatorios.");
        return;
      }
      const url = getUrl();
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(getCsrfToken() ? { "X-CSRFToken": getCsrfToken() } : {}),
        },
        body: JSON.stringify({ titulo, mensaje }),
      });
      if (!resp.ok) {
        alert("No se pudo enviar la comunicación.");
        return;
      }
      if (elTitulo) elTitulo.value = "";
      if (elMensaje) elMensaje.value = "";
      await loadRows();
    });

    proyectoEl.addEventListener("change", loadRows);
    loadRows();
  })();
</script>

<script>
  (function () {
    const lists = document.querySelectorAll("[data-doc-list]");
    lists.forEach((list) => {
      const items = Array.from(list.querySelectorAll("li"));
      const pageSize = parseInt(list.dataset.pageSize || "10", 10);
      const controls = list.parentElement.querySelector("[data-doc-controls]");
      const btnPrev = controls ? controls.querySelector("[data-doc-prev]") : null;
      const btnNext = controls ? controls.querySelector("[data-doc-next]") : null;
      const pageLabel = controls ? controls.querySelector("[data-doc-page]") : null;
      if (!controls || items.length <= pageSize) {
        if (controls) {
          controls.style.display = "none";
        }
        return;
      }

      let page = 1;
      const totalPages = Math.max(1, Math.ceil(items.length / pageSize));

      const render = () => {
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        items.forEach((item, idx) => {
          item.style.display = idx >= start && idx < end ? "" : "none";
        });
        if (pageLabel) {
          pageLabel.textContent = `${page} / ${totalPages}`;
        }
        if (btnPrev) btnPrev.disabled = page <= 1;
        if (btnNext) btnNext.disabled = page >= totalPages;
      };

      if (btnPrev) {
        btnPrev.addEventListener("click", () => {
          page = Math.max(1, page - 1);
          render();
        });
      }
      if (btnNext) {
        btnNext.addEventListener("click", () => {
          page = Math.min(totalPages, page + 1);
          render();
        });
      }

      render();
    });
  })();
</script>
{% endblock %}
